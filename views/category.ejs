<%- include('partials/header',{
  title: categoryName,
  description: categoryDesc,
  name,
  showGetStarted:false
}) %>

<section class="category-head">
  <h1><%= categoryName %></h1>
  <p><%= categoryDesc %></p>
</section>

<section class="endpoint-list">

<% category.items.forEach((ep,i)=>{ %>

  <div class="card">

    <!-- ENDPOINT BAR -->
    <div class="endpoint-bar" onclick="toggleTry(<%= i %>)">
      <span class="method"><%= ep.method %></span>
      <span class="path"><%= ep.path %></span>
      <span id="icon-<%= i %>">⌄</span>
    </div>

    <!-- TRY PANEL -->
    <div class="try-box" id="try-<%= i %>">

      <% if(ep.alias){ %>
        <p class="alias"><%= ep.alias %></p>
      <% } %>

      <form onsubmit="executeAPI(event,<%= i %>,'<%= ep.path %>','<%= ep.method %>')">

        <% if(ep.params){ %>
          <% Object.entries(ep.params).forEach(([key,val])=>{ %>
            <div class="field">
              <input
                name="<%= key %>"
                placeholder="<%= val.example || '' %>"
                title="<%= val.desc || '' %>"
                required
              />
              <% if(val.desc){ %>
                <small><%= val.desc %></small>
              <% } %>
            </div>
          <% }) %>
        <% } %>

        <button class="exec">Execute</button>
      </form>

      <pre id="result-<%= i %>" class="result">
Response will appear here…
      </pre>

    </div>
  </div>

<% }) %>

</section>

<script>
function toggleTry(i){
  const box = document.getElementById('try-'+i)
  const icon = document.getElementById('icon-'+i)
  const open = box.style.display === 'block'
  box.style.display = open ? 'none' : 'block'
  icon.textContent = open ? '⌄' : '⌃'
}

async function executeAPI(e,i,path,method){
  e.preventDefault()
  const form = e.target
  const out = document.getElementById('result-'+i)
  out.textContent = 'Loading...'

  try{
    const data = Object.fromEntries(new FormData(form))
    let res

    if(method === 'GET'){
      const url = new URL(path,location.origin)
      Object.entries(data).forEach(([k,v])=>{
        url.searchParams.append(k,v)
      })
      res = await fetch(url)
    }else{
      res = await fetch(path,{
        method,
        headers:{'Content-Type':'application/json'},
        body: JSON.stringify(data)
      })
    }

    const json = await res.json()
    out.textContent = JSON.stringify(json,null,2)

  }catch(err){
    out.textContent = 'Error: ' + err.message
  }
}
</script>

<%- include('partials/footer',{name}) %>